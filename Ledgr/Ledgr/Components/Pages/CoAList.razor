@page "/CoAList/{Username}"
@using LedgrLogic
@inject NavigationManager NavigationManager
@inject Navigation Nav

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chart of Accounts</title>

  <!-- Global theme -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Oswald:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  <!-- Accounts-only styles -->
  <link rel="stylesheet" href="accounts.css" />
  <link rel="stylesheet" href="dashboard.css" />

</head>

<body class="page">
  
<!-- Header -->
<!-- HEADER -->
<header class="app-header">
  <div class="app-header__top">
    <div class="brand">
      <img src="/logo-slogan.png" alt="LEDGR Logo" class="brand__logo" />
    </div>

    <div class="user">
      <button @onclick="LogoutVisibility" id="userMenuBtn" class="user__btn" aria-haspopup="menu" aria-expanded="false">
        <svg class="icon icon--user" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5Z"/>
        </svg>
        <span class="user__name">@Username</span>
        <svg class="icon icon--caret" viewBox="0 0 24 24" aria-hidden="false"><path d="M7 10l5 5 5-5H7z"/></svg>
      </button>
      @if (ShowLogout)
      {
      <button @onclick="Nav.LogOut" class="menu__item" role="menuitem" id="logoutBtn">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="false">
          <path d="M10 17l1.41-1.41L8.83 13H21v-2H8.83l2.58-2.59L10 7l-5 5 5 5zM4 19h6v2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h6v2H4v14z"/>
        </svg>
        Log out
      </button>
      }
    </div>
  </div>

  <nav class="app-nav" aria-label="Primary">
    <div class="app-nav__inner">
      <ul class="app-nav__list">
        <li><a @onclick="(() => Nav.Home(Username))" class="app-nav__link" href="#">Dashboard</a></li>
        <li><a @onclick="(() => Nav.CoAListCall(Username))" class="app-nav__link is-active" href="#">Chart of Accounts</a></li>
        <li><a @onclick="(() => Nav.CoAEventLog(Username))" class="app-nav__link" href="#">Event Log</a></li>
        <li><a @onclick="(() => Nav.AdjustJournal(Username))" class="app-nav__link" href="#">Journal</a></li>
        <li><a @onclick="(() => Nav.Reports(Username))" class="app-nav__link" href="#">Reports</a></li>
      </ul>
    </div>
  </nav>
</header>

<SideBar>
  <button @onclick="(() => Nav.Home(Username))" type="button" class="btn-nav" style="background-color: #1e1e2f; color: #FFFFFF; border: none">Dashboard</button>
  <button @onclick="(() => Nav.CoAListCall(Username))" type="button" class="btn-nav" style="background-color: #1e1e2f; color: #FFFFFF; border: none">Chart of Accounts List</button>
  <button @onclick="(() => Nav.CoAForm(Username))" type="button" class="btn-nav" style="background-color: #1e1e2f; color: #FFFFFF; border: none" >Chart of Accounts Form</button>
  <button @onclick="(() => Nav.CoAEventLog(Username))" type="button" class="btn-nav" style="background-color: #1e1e2f; color: #FFFFFF; border: none" >Chart of Accounts Event Log</button>
  @if (Role == "Admin")
  {
  <button @onclick="() => Nav.ManageUser(Username)" type="button" class="btn-nav" style="background-color: #1e1e2f; color: #FFFFFF; border: none">Manage Users</button>
  <button @onclick="() => Nav.PasswordReport(Username)" type="button" class="btn-nav" style="background-color: #1e1e2f; color: #FFFFFF; border: none">Password Report</button>
  }
</SideBar>

<!-- DATE DROPDOWN BOX -->
<div class="toolbar">
  <button id="dateBtn" class="date-btn" aria-haspopup="dialog" aria-expanded="false">
    <svg class="icon icon--calendar" viewBox="0 0 24 24" aria-hidden="true">
      <path d="M7 2v2H5a2 2 0 0 0-2 2v2h18V6a2 2 0 0 0-2-2h-2V2h-2v2H9V2H7Zm14 8H3v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V10Zm-14 4h6v4H7v-4Z"/>
    </svg>
    <span id="dateText">@CalendarDate</span>
  </button>
  <input id="dateInput" type="date" class="visually-hidden">
</div>

<!-- CALENDAR -->
<div id="calendarPopover" class="cal" role="dialog" aria-modal="true" aria-labelledby="calLabel" hidden>
  <div class="cal__inner">
    <div class="cal__header">
      <button class="cal__nav" data-dir="-1" aria-label="Previous month">‹</button>
      <div id="calLabel" class="cal__label">October 2025</div>
      <button class="cal__nav" data-dir="1" aria-label="Next month">›</button>
    </div>
    <div class="cal__grid cal__dow">
      <span>Su</span><span>Mo</span><span>Tu</span><span>We</span><span>Th</span><span>Fr</span><span>Sa</span>
    </div>
    <div id="calGrid" class="cal__grid"></div>
  </div>
</div>

<!-- Main -->
<main class="container container--xl">

  <!-- Top-left calendar -->
  <section class="toolbar" aria-label="Calendar and quick actions">
    <div class="input-group">
      <label class="label" for="coaDateFrom">From</label>
      <input id="coaDateFrom" type="date" class="input" />
    </div>

    <div class="input-group">
      <label class="label" for="coaDateTo">To</label>
      <input id="coaDateTo" type="date" class="input" />
    </div>
    <button id="btnApplyDates" class="btn btn--primary btn--small" type="button">Apply Dates</button>
    <button type="button" @onclick="AddAccount" class="btn btn--primary btn--small" role="button">Add Account</button>
  </section>

  <section class="card1 card--fluid" aria-labelledby="coaTitle">      
    <header class="card__header">
      <h1 id="coaTitle" class="h2">Chart of Accounts</h1>
      <p class="body1 muted">Search and filter accounts; click an account to open its ledger.</p>
    </header>

    <div class="card__body">
      <form id="coaFilterForm" class="grid grid--cols-6 grid--gap">
        <div class="input-group">
          <label class="label" for="fCategory">Category</label>
          <InputSelect @bind-Value="Category" id="fCategory" class="input">
            <option value="">All</option>
            <option value="Asset">Asset</option>
            <option value="Liability">Liability</option>
            <option value="Equity">Equity</option>
            <option value="Revenue">Revenue</option>
            <option value="Expense">Expense</option>
          </InputSelect>
        </div>

        <div class="input-group">
          <label class="label" for="fSubcategory">Subcategory</label>
          <InputText @bind-Value="Subcategory" id="fSubcategory" class="input" type="text" placeholder="e.g., Current Assets" />
        </div>

        <div class="input-group">
          <label class="label" for="fNormalSide">Normal Side</label>
          <InputSelect @bind-Value="NormalSide" id="fNormalSide" class="input">
            <option value="" selected>All</option>
            <option value="Debit">Debit</option>
            <option value="Credit">Credit</option>
          </InputSelect>
        </div>

        <div class="input-group">
          <label class="label" for="fAcctFrom">Acct # From</label>
          <InputText @bind-Value="AcctNumFrom" id="fAcctFrom" class="input" type="number" inputmode="numeric" />
        </div>

        <div class="input-group">
          <label class="label" for="fAcctTo">Acct # To</label>
          <InputText @bind-Value="AcctNumTo" id="fAcctTo" class="input" type="number" inputmode="numeric" />
        </div>

        <div class="input-group">
          <label class="label" for="fAmtMin">Amount Min</label>
          <InputText @bind-Value="AcctMin" id="fAmtMin" class="input" type="number" step="0.01" />
        </div>

        <div class="input-group">
          <label class="label" for="fAmtMax">Amount Max</label>
          <InputText @bind-Value="AcctMax" id="fAmtMax" class="input" type="number" step="0.01" />
        </div>

        <div class="input-group" style="grid-column: span 2;">
          <label class="label" for="fSearch">Search</label>
          <InputText @bind-Value="Search" id="fSearch" class="input" type="search" placeholder="Account number or name" />
        </div>

        <div class="input-group" style="align-self:end;">
          <button @onclick="ClearFilter" type="button" id="btnClearFilters" class="btn btn--secondary">Clear Filters</button>
        </div>
        <div class="input-group" style="align-self:end;">
          <button @onclick="FilterCoA" type="button" class="btn btn--primary">Apply Filters</button>
        </div>
      </form>
    </div>

    
    <div class="card__body">
      <div class="table-actions">
        <a @onclick="CoAEventLog" href="#" class="btn btn--secondary" type="button" title="View all account changes">View Event Log</a>
        <!--<button id="btnExportCsv" class="btn btn--secondary" type="button">Export CSV</button>-->
      </div>
      

        

      <div id="coaAlert" class="alert -error is-hidden" role="alert" aria-live="polite">
        <span class="alert__dot" aria-hidden="true"></span>
        <span class="alert__text" id="coaAlertText">There was a problem loading accounts.</span>
      </div>

      <div class="table-wrap">
        <table class="table" aria-describedby="coaCaption">
          <caption id="coaCaption" class="sr-only">Accounts with monetary values shown to two decimals and thousand separators.</caption>
          <thead>
          <tr>
            <th>Account No.</th>
            <th>Name</th>
            <!-- th>Description</th -->
            <!-- <th>Normal Side</th> -->
            <th>Category</th>
            <th>Subcategory</th>
            <!-- th>Initial Balance</th -->
            <!-- th>Debit</th -->
            <!-- th>Credit</th -->
            <th>Balance</th>
            <th>Created</th>
            <!-- th>Added By</th -->
            <!-- th>Order</th -->
            <th>Statement</th>
            <!-- <th>Updated</th> -->
            <!--th>Status</th-->
            <th class="text-right">Actions</th>
          </tr>
          </thead>
          <tbody id="coaRows">
          @if (Accounts.Count > 0)
          {
            @for (int i = 0; i < Accounts.Count; i += 15)
            {
              int index = i;
              <tr class="muted">

                <td><a @onclick="(() => ViewLedger(Accounts[index]))" href="#">@Accounts[index]</a></td>
                <td><a @onclick="(() => ViewLedger(Accounts[index]))" href="#">@Accounts[index + 1]</a></td>
                <!-- td>@Accounts[index + 2]</td -->
                <!-- <td>@Accounts[index + 3]</td> -->
                <td>@Accounts[index + 4]</td>
                <td>@Accounts[index + 5]</td>
                
                <!-- Initial, Debits, Credits, Balance -->
                <!-- td style="text-align: right">@Accounts[index + 6]</td -->
                <!-- td style="text-align: right">@Accounts[index + 7]</td -->
                <!-- td style="text-align: right">@Accounts[index + 8]</td -->
                <td style="text-align: right">@Accounts[index + 9]</td>
                
                <td>@Accounts[index + 10]</td>
                <!-- td>@Accounts[index + 11]</td -->
                <!-- td>@Accounts[index + 12]</td -->
                <td>@Accounts[index + 13]</td>
                <!--td>@Accounts[index + 14]</td-->
                @if (Role == "Admin")
                {
                  <td><button @onclick="(() => AccountEdit(index))" type="button" class="btn btn-primary">View</button></td>
                }
                @if (Role == "Manager")
                {
                  <td><button @onclick="(() => AccountView(index))" type="button" class="btn btn-primary">View</button></td>
                }
                @if (Role == "Accountant")
                {
                <td><button @onclick="(() => AccountView(index))" type="button" class="btn btn-primary">View</button></td>
                }
              </tr>
            } 
          }
          @if (Accounts.Count <= 0)
          {
            <tr>
              <td colspan="17" style="text-align:center; padding:24px;">Loading…</td>
            </tr>
          }
          </tbody>
        </table>
      </div>

      <nav class="pagination" aria-label="Accounts pages">
        <button class="btn btn--secondary" id="pgPrev" type="button" disabled>Prev</button>
        <span class="pagination__status" id="pgStatus">Page 1 of 1</span>
        <button class="btn btn--secondary" id="pgNext" type="button" disabled>Next</button>
      </nav>

      <p class="body2 muted" style="margin-top:16px;">
        <strong>Legend:</strong> IS = Income Statement, BS = Balance Sheet, RE = Retained Earnings
      </p>
    </div>
  </section>
  <AccountActionsAdmin Show="@showActions" Username="@Username" AcctNum="@AcctNum" ShowChanged="val => showActions = val"></AccountActionsAdmin>
</main>

<!-- Footer -->
<footer class="app-footer">
  <div class="app-footer__inner">
    <nav class="footer-nav">
      <a @onclick="() => Nav.HelpPage(Username)" href="#" class="link">Help</a>
      <a href="/privacy.html" class="link">Privacy</a>
      <a href="/terms.html" class="link">Terms</a>
    </nav>
    <small class="muted">© 2025 LEDGR · Build v0.1</small>
  </div>
</footer>

<!-- Global JS + Accounts module -->
<script src="app.js"></script>
<script src="accounts.js"></script> 
<script>
  window.addEventListener('DOMContentLoaded', function(){
    window.coa?.initListPage?.({
      tableSel:'#coaRows',
      alertSel:'#coaAlert',
      alertTextSel:'#coaAlertText',
      exportBtn:'#btnExportCsv',
      clearBtn:'#btnClearFilters',
      formSel:'#coaFilterForm',
      dateFrom:'#coaDateFrom',
      dateTo:'#coaDateTo',
      searchSel:'#fSearch',
      pagination:{prev:'#pgPrev', next:'#pgNext', status:'#pgStatus'},
      addBtn:'#btnAddAccount'
    });
  });
</script>

</body>
</html>

@code{

  [Parameter] public string? Username { get; set; }
  public string Role { get; set; } = string.Empty;
  public string CalendarDate = DateTime.Today.ToString("M");


  private List<string> Accounts = new List<string>();
  private List<string> MasterAccounts = new List<string>();
  private bool showActions { get; set; } = false;
  private string AcctNum { get; set; } = "-1";

  // Sorting
  private string Category { get; set; } = string.Empty;
  private string Subcategory { get; set; } = string.Empty;
  private string NormalSide { get; set; } = string.Empty;
  private string AcctNumFrom { get; set; } = string.Empty;
  private string AcctNumTo { get; set; } = string.Empty;
  private string AcctMin { get; set; } = string.Empty;
  private string AcctMax { get; set; } = string.Empty;
  private string Search { get; set; } = string.Empty;

  public async Task FilterCoA()
  {
    Accounts = new List<string>();
    foreach (string data in MasterAccounts)
    {
      Accounts.Add(data);
    }
     Accounts = await Filter.CoAList(Accounts, Category, Subcategory, NormalSide, AcctNumFrom, AcctNumTo, AcctMin, AcctMax, Search);
     StateHasChanged();
  }

  public void ClearFilter()
  {
    Category  = string.Empty;
    Subcategory  = string.Empty;
    NormalSide  = string.Empty;
    AcctNumFrom  = string.Empty;
    AcctNumTo = string.Empty;
    AcctMin  = string.Empty;
    AcctMax  = string.Empty;
    Search  = string.Empty;
    
    Accounts = new List<string>();
    foreach (string data in MasterAccounts)
    {
      Accounts.Add(data);
    }
  }

  protected override async Task OnParametersSetAsync()
  {
    Role = (await Admin.GetUserFromUserName(Username)).GetRole();
    Accounts = Account.GetAccounts("").Result;

    for (int i = 0; i < Accounts.Count; i += 15)
    {
      Accounts[i + 6] = Convert.ToDouble(Accounts[i + 6]).ToString("N2");
      Accounts[i + 7] = Convert.ToDouble(Accounts[i + 7]).ToString("N2");
      Accounts[i + 8] = Convert.ToDouble(Accounts[i + 8]).ToString("N2");
      Accounts[i + 9] = Convert.ToDouble(Accounts[i + 9]).ToString("N2");
    }

    foreach (string data in Accounts)
    {
      MasterAccounts.Add(data);
    }
    
  }
  
  public void showActionsDialog(int index)
  {
    AcctNum = (Accounts[index]);
    showActions = true;
  }
  
  public void AddAccount()
  {
    NavigationManager.NavigateTo($"/CoAForm/{Username}");
  }

  public void ViewLedger(string acctNum)
  {
    NavigationManager.NavigateTo($"/ledger/{Username}/{acctNum}");
  }
  
  // Nav Buttons - Linked to side bar
  public void Home()
  {
    NavigationManager.NavigateTo($"/dashboard/{Username}");
  }

  public void CoAListCall()
  {
    NavigationManager.NavigateTo($"/CoAList/{Username}");
  }
    
  public void CoAForm()
  {
    NavigationManager.NavigateTo($"/CoAForm/{Username}");
  }
  public void CoAEventLog()
  {
    NavigationManager.NavigateTo($"/CoAEventLog/{Username}");
  }
  public void PasswordReport()
  {
    NavigationManager.NavigateTo($"/pwReport/{Username}");
  }

  public void AccountEdit(int index)
  {
    string AccountNum = Accounts[index];
    NavigationManager.NavigateTo($"/CoAFormEdit/{Username}/{AccountNum}"); 
  }

  public void AccountView(int index)
  {
    string AccountNum = Accounts[index];
    NavigationManager.NavigateTo($"/CoAFormView/{Username}/{AccountNum}"); 
  }

  public bool ShowLogout { get; set; } = false;
  public void LogoutVisibility()
  {
    ShowLogout = !ShowLogout;
  }

}