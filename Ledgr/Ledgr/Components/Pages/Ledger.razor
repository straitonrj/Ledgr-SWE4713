@page "/ledger/{Username}/{AccountNum}"
@using LedgrLogic
@using Microsoft.AspNetCore.Components.Sections
@using MudBlazor.Charts
@inject NavigationManager NavigationManager
@inject Navigation Nav

<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ledger • LEDGR</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Oswald:wght@500;700&display=swap" rel="stylesheet">

    <!-- Base + Page Styles -->
    <link rel="stylesheet" href="/styles.css" />
    <link rel="stylesheet" href="/ledger.css" />
    <link rel="stylesheet" href="/accounts.css" />

</head>
<body class="page page--ledger" data-page="ledger">

<!-- ---------- HEADER ---------- -->
<header class="app-header">
    <div class="app-header__top">
        <div class="brand">
            <img src="logo-slogan.png" alt="LEDGR Logo" class="brand__logo" />
        </div>

        <div class="user">
            <button id="userMenuBtn" class="user__btn" aria-haspopup="menu" aria-expanded="false">
                <svg class="icon icon--user" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5Z"/>
                </svg>
                <span class="user__name">@Username</span>
                <svg class="icon icon--caret" viewBox="0 0 24 24" aria-hidden="true"><path d="M7 10l5 5 5-5H7z"/></svg>
            </button>

            <!-- Dropdown -->
            <div id="userMenu" class="menu" role="menu" aria-labelledby="userMenuBtn">
                <button class="menu__item" role="menuitem" id="logoutBtn">
                    <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"></svg>
                    Log out
                </button>
            </div>
        </div>
    </div>

    <!-- Primary nav -->
    <nav class="app-nav" aria-label="Primary">
        <div class="app-nav__inner">
            <ul class="app-nav__list">
                <li><a @onclick="() => Nav.Home(Username)" class="app-nav__link" href="#">Dashboard</a></li>
                <li><a @onclick="() => Nav.CoAListCall(Username)" class="app-nav__link" href="#">Chart of Accounts</a></li>
                <li><a @onclick="() => Nav.CoAEventLog(Username)" class="app-nav__link" href="#">Event Log</a></li>
                <li><a @onclick="() => Nav.JournalCall(Username)" class="app-nav__link" href="#">Journal</a></li>
                <li><a @onclick="(() => Nav.AdjustJournal(Username))" class="app-nav__link" href="#">Adjusting Entries</a></li>
                <li><a @onclick="() => Nav.Reports(Username)" class="app-nav__link" href="#">Reports</a></li>
            </ul>
        </div>
    </nav>
</header>

<SideBar>
    <button @onclick="(() => Nav.Home(Username))" type="button" class="btn-nav" style="background-color: #1e1e2f; color: #FFFFFF; border: none">Dashboard</button>
    <button @onclick="(() => Nav.CoAListCall(Username))" type="button" class="btn-nav" style="background-color: #1e1e2f; color: #FFFFFF; border: none">Chart of Accounts List</button>
    <button @onclick="(() => Nav.CoAForm(Username))" type="button" class="btn-nav" style="background-color: #1e1e2f; color: #FFFFFF; border: none" >Chart of Accounts Form</button>
    <button @onclick="(() => Nav.CoAEventLog(Username))" type="button" class="btn-nav" style="background-color: #1e1e2f; color: #FFFFFF; border: none" >Chart of Accounts Event Log</button>
    @if (Role == "Admin")
    {
    <button @onclick="() => Nav.ManageUser(Username)" type="button" class="btn-nav" style="background-color: #1e1e2f; color: #FFFFFF; border: none">Manage Users</button>
    <button @onclick="() => Nav.PasswordReport(Username)" type="button" class="btn-nav" style="background-color: #1e1e2f; color: #FFFFFF; border: none">Password Report</button>
    }
</SideBar>

<!-- ---------- DATE PICKER ---------- -->
<div class="toolbar">
    <button id="dateBtn" class="date-btn" aria-haspopup="dialog" aria-expanded="false">
        <svg class="icon icon--calendar" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M7 2v2H5a2 2 0 0 0-2 2v2h18V6a2 2 0 0 0-2-2h-2V2h-2v2H9V2H7Zm14 8H3v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V10Zm-14 4h6v4H7v-4Z"/>
        </svg>
        <span id="dateText">@CalendarDate</span>
    </button>
    <input id="dateInput" type="date" class="visually-hidden">
</div>

<!-- ---------- CALENDAR ---------- -->
<div id="calendarPopover" class="cal" role="dialog" aria-modal="true" aria-labelledby="calLabel" hidden>
    <div class="cal__inner">
        <div class="cal__header">
            <button class="cal__nav" data-dir="-1" aria-label="Previous month">‹</button>
            <div id="calLabel" class="cal__label">October 2025</div>
            <button class="cal__nav" data-dir="1" aria-label="Next month">›</button>
        </div>
        <div class="cal__grid cal__dow">
            <span>Su</span><span>Mo</span><span>Tu</span><span>We</span><span>Th</span><span>Fr</span><span>Sa</span>
        </div>
        <div id="calGrid" class="cal__grid"></div>
    </div>
</div>

<!-- ---------- MAIN CONTENT ---------- -->
<main class="containerLedger">

    <!-- Page Heading -->
    <section class="page-head">
        <div>
            <h1 class="h2">Account Ledger</h1>
            <h2 class="h3">Select an account from Chart of Accounts or use search.</h2>
        </div>
    </section>

    <!-- Account summary card -->
    <section id="accountCard" class="card1 hide">
        <div class="grid grid--2">
            <div>
                <div class="muted">Account</div>
                <div class="h3" id="acctName">@AccountDetails[1]</div>
                <div class="muted" id="acctNumber">@AccountDetails[0]</div>
            </div>
            <div class="grid grid--2">
                <div>
                    <div class="muted">Category</div>
                    <div id="acctCategory">@AccountDetails[4]</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Ledger Table -->
    <section class="card1">
        <div class="table-wrap">
             <!-- Filters -->
            <section class="toolbar">
                <div class="toolbar__group">
                    <label class="field">
                        <span class="field__label">From</span>
                        <input type="date" id="dateFrom" class="field__input"/>
                    </label>
                    <label class="field">
                        <span class="field__label">To</span>
                        <input type="date" id="dateTo" class="field__input"/>
                    </label>
                </div>
                <div class="toolbar__group">
                    <label class="field field--search">
                        <!--span class="sr-only">Search</!--span-->
                        <input type="search" id="searchBox" class="field__input" placeholder="Search by account name, amount, or PR"/>
                    </label>
                    <button id="clearFiltersBtn" class="btn btn--secondary">Clear</button>
                    <button id="exportCsvBtn" class="btn btn--primary">Export CSV</button>
                </div>
            </section>
            <table class="table" id="ledgerTable" role="grid" aria-label="Account ledger">
                <!-- Table: First Row -->
                <thead>
                <tr>
                    <th scope="col">Date</th>
                    <th scope="col">Description</th>
                    <th scope="col">PR</th>
                    <th scope="col" style="text-align: right">Debit</th>
                    <th scope="col" style="text-align: right">Credit</th>
                    <th scope="col" style="text-align: right">Balance</th>
                </tr>
                </thead>
                <tbody id="ledgerTbody">
                @for (int i = 0; i < LedgerListDebits.Count; i += 7)
                {
                    int index = i;
                    <tr>
                        <td>@LedgerListDebits[index + 2]</td>
                        @if (LedgerListDebits[index + 3] == string.Empty)
                        {
                            <td>-- --</td>
                        }
                        @if (LedgerListDebits[index + 3] != string.Empty)
                        {
                            <td>@LedgerListDebits[index + 3]</td>
                        }
                        <td>JE-@LedgerListDebits[index + 6]</td>
                        @if (LedgerListDebits[index + 4] == "Debit")
                        {
                            <td style="text-align: right">@LedgerListDebits[index + 5]</td>
                            <td></td>

                        }
                        @if (LedgerListDebits[index + 4] == "Credit")
                        {
                            <td></td>
                            <td style="text-align: right">@LedgerListDebits[index + 5]</td>
                        }
                        <td style="text-align: right">@RunningBalance[index / 7]</td>
                    </tr>
                }
                @for (int i = 0; i < LedgerListCredits.Count; i += 7)
                {
                    int index = i;
                    <tr>
                        <td>@LedgerListCredits[index + 2]</td>
                        @if (LedgerListCredits[index + 3] == string.Empty)
                        {
                            <td>-- --</td>
                        }
                        @if (LedgerListCredits[index + 3] != string.Empty)
                        {
                            <td>@LedgerListCredits[index + 3]</td>
                        }
                        <td>JE-@LedgerListCredits[index + 6]</td>
                        @if (LedgerListCredits[index + 4] == "Debit")
                        {
                            <td style="text-align: right">@LedgerListCredits[index + 5]</td>
                            <td></td>

                        }
                        @if (LedgerListCredits[index + 4] == "Credit")
                        {
                            <td></td>
                            <td style="text-align: right">@LedgerListCredits[index + 5]</td>
                        }
                        <td style="text-align: right">@RunningBalance[index / 7]</td>
                    </tr>
                }
                <tr>
                    <td class="" scope="col"><strong>Totals</strong></td>
                    <td scope="col"></td>
                    <td class="num" scope="col" id="endingBalance"></td>
                    <td class="num" scope="col" id="totalDebit"><strong>$@FormattedTotalDebits</strong></td>
                    <td class="num" scope="col" id="totalCredit"><strong>$@FormattedTotalCredits</strong></td>
                    <td scope="col" style="text-align: right"><strong>$@RunningBalance[RunningBalance.Count - 1]</strong></td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- Empty state message -->
        <div id="emptyState" class="empty-state hide">
            <p>No entries match your filters.</p>
            <button id="resetFiltersBtn" class="btn btn--ghost">Reset filters</button>
        </div>
    </section>
</main>

<!-- ---------- JOURNAL MODAL (read-only) ---------- -->
<dialog id="journalModal" class="modal">
    <form method="dialog" class="modal__card">
        <header class="modal__head">
            <h2 class="h3">Journal Entry</h2>
            <button class="icon-btn" value="close" aria-label="Close">✕</button>
        </header>
        <div class="modal__body" id="journalBody">
            <!-- populated by JS -->
        </div>
        <footer class="modal__foot">
            <button class="btn" value="close">Close</button>
        </footer>
    </form>
</dialog>

<!-- ---------- EVENT LOG MODAL ---------- -->
<dialog id="eventLogModal" class="modal">
    <form method="dialog" class="modal__card">
        <header class="modal__head">
            <h2 class="h3">Event Log</h2>
            <button class="icon-btn" value="close" aria-label="Close">✕</button>
        </header>
        <div class="modal__body">
            <div id="eventLogList"></div>
        </div>
        <footer class="modal__foot">
            <button class="btn" value="close">Close</button>
        </footer>
    </form>
</dialog>

<!-- Footer -->
<footer class="app-footer">
    <div class="app-footer__inner">
        <nav class="footer-nav">
            <a @onclick="() => Nav.HelpPage(Username)" href="#" class="link">Help</a>
            <a href="/privacy.html" class="link">Privacy</a>
            <a href="/terms.html" class="link">Terms</a>
        </nav>
        <small class="muted">© 2025 LEDGR · Build v0.1</small>
    </div>
</footer>

<!-- ---------- SCRIPTS ---------- -->
<script src="/app.js"></script>
<script src="/journal.js"></script>
<!--script src="/ledger.js"></!--script-->
</body>
</html>

@code {

    [Parameter] public string Username { get; set; }
    [Parameter] public string AccountNum { get; set; }
    public string Role { get; set; } = string.Empty;
    public string CalendarDate = DateTime.Today.ToString("M");

    public List<string> LedgerList { get; set; }
    public List<string> LedgerListDebits { get; set; } = new List<string>();
    public List<string> LedgerListCredits { get; set; } = new List<string>();
    
    public List<string> RunningBalance { get; set; } = new List<string>();
    public List<string> AccountDetails;

    public List<double> TotalDebits { get; set; } = new List<double>();
    public List<double> TotalCredits { get; set; } = new List<double>();

    public List<string> FormattedDebits { get; set; } = new List<string>();
    public List<string> FormattedCredits { get; set; } = new List<string>();

    public string FormattedTotalDebits => TotalDebits.Sum().ToString("N2");
    public string FormattedTotalCredits => TotalCredits.Sum().ToString("N2");
    
    

    
    // Get the permissions of the User and Initialize data for page
    protected override async Task OnParametersSetAsync()
    {
        AccountDetails =  Account.GetAccountFromAccountNumber(Convert.ToInt32(AccountNum)).Result;
        Role = (await Admin.GetUserFromUserName(Username)).GetRole();
        LedgerList = Manager.GetLedger(Convert.ToInt32(AccountNum));
        
        for (int i = 0; i < LedgerList.Count; i+=7)
        {
            // Separate Section for Balance Handling
            if (LedgerList[i + 4] == "Debit")
            {
                TotalDebits.Add(Convert.ToDouble(LedgerList[i + 5]));
                
                // If the data is for a debit, add all data into the debits list
                for (int j = i; j < i + 7; j++)
                {
                    if (j == i + 5)
                    {
                        LedgerListDebits.Add(Convert.ToDouble(LedgerList[i + 5]).ToString("N2"));
                        continue;
                    }
                    LedgerListDebits.Add(LedgerList[j]);
                }
            }
            else
            {
                TotalCredits.Add(Convert.ToDouble(LedgerList[i+5]));
                // If the data is for a credit, add all data into the credits list
                for (int j = i; j < i + 7; j++)
                {
                    if (j == i + 5)
                    {
                        LedgerListCredits.Add(Convert.ToDouble(LedgerList[i + 5]).ToString("N2"));
                        continue;
                    }
                    LedgerListCredits.Add(LedgerList[j]);
                }
            }
            
            if (RunningBalance.Count == 0)
            {
                if (LedgerList[i + 4] == "Credit")
                {
                    string formattedBalanceNeg = (Convert.ToDouble(LedgerList[i + 5]) * -1).ToString("N2");
                    RunningBalance.Add(formattedBalanceNeg);
                    continue;
                }
                string formattedBalance = (Convert.ToDouble(LedgerList[i + 5])).ToString("N2");
                RunningBalance.Add(formattedBalance);
                continue;
            }

            if (LedgerList[i + 4] == "Credit")
            {
                double sub = Convert.ToDouble(LedgerList[i + 5]);
                double diff = Convert.ToDouble(RunningBalance[(i/7) - 1]) - sub;
                string formDiff = diff.ToString("F2");
                RunningBalance.Add(formDiff);
                continue;
            } 
            double add = Convert.ToDouble(LedgerList[i + 5]);
            double sum = Convert.ToDouble(RunningBalance[(i/7) - 1]) + add;
            string formSum = sum.ToString("F2");
            RunningBalance.Add(formSum);
        }

        foreach (double dr in TotalDebits)
        {
            FormattedDebits.Add(dr.ToString("F2"));
        }

        foreach (double cr in TotalCredits)
        {
            FormattedCredits.Add(cr.ToString("F2"));
        }
    }
}