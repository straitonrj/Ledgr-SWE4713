@using System.Reflection.Metadata
@using Google.Apis.Gmail.v1
@using LedgrLogic
@using MudBlazor
@inject NavigationManager NavigationManager
@page "/"

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LEDGR — Sign In</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Oswald:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
<header class="site-header" role="banner" aria-label="LEDGR global header">
    <div class="header-inner">
        <img src="logo-slogan.png" alt="LEDGR — The smart way to balance business." class="brand-logo"/>
    </div>
</header>

<main class="site-main" role="main">
    <section class="auth" aria-labelledby="auth-title">
        <div class="card" role="region" aria-label="Sign in form">
            <h1 id="auth-title" class="auth-title">Sign In</h1>
            <p class="auth-subtitle">Use your username and password.</p>

            @if (FormEnabled)
            {
                <!-- Need to insert proper code for an alerts system -->
                @if (SuspendedAccount != string.Empty)
                {
                    <div class="alert">
                        <p><strong>@SuspendedAccount</strong></p>
                    </div>
                }
                @if (MissingRole != string.Empty)
                {
                    <div class="alert">
                        <p><strong>@MissingRole</strong></p>
                    </div>
                }
                @if (IncorrectUsername != string.Empty)
                {
                    <div class="alert">
                        <p><strong>@IncorrectUsername</strong></p>
                    </div>
                }
                @if (AccountMismatch != string.Empty)
                {
                    <div class="alert">
                        <p><strong>@AccountMismatch</strong></p>
                    </div>
                }
                @if (IncorrectPassword != string.Empty)
                {
                    <div class="alert">
                        <p><strong>@IncorrectPassword</strong></p>
                    </div>
                }
                <form class="form" action="" method="get" novalidate>
                    <div class="field">
                        <label for="email">Username</label>
                        <InputText id="email" name="email" type="email" autocomplete="email" placeholder="Username" required @bind-Value="Username"/>
                        <p class="field-help sr-only" id="email-help">Enter your username.</p>
                    </div>

                    <div class="field">
                        <div class="field-row">
                            <label for="password">Password</label>
                            <NavLink class="link-small" href="/fpwIdentify">Forgot password?</NavLink>
                        </div>
                        <InputText id="password" name="password" type="password" autocomplete="current-password" placeholder="••••••••" required @bind-Value="Password"/>
                        <p>You have @Attempts attempts remaining</p>
                    </div>

                    <!-- Role -->
                    <label class="field">
                        <span class="field__label">Role</span>
                        <InputSelect @bind-Value="Role" id="role" name="role" class="input">
                            <option value="Administrator" selected>Administrator</option>
                            <option value="Manager">Manager</option>
                            <option value="Accountant" selected>Accountant</option>
                        </InputSelect>
                    </label>

                    <button @onclick="VerifyLoginAsync" type="button" class="btn btn-primary">Sign in</button>

                    <p class="footer-line">
                        <span class="muted">Need an account?</span>
                        <NavLink href="/cUser" class="link">Create one</NavLink>
                    </p>
                    <AntiforgeryToken/>
                </form>
            }
            else
            {
                <div class="alert">
                    <p><strong>@AccountDisabled</strong></p>
                </div>
                <form class="form" action="" method="get" novalidate>
                    <div class="field">
                        <label for="email">Username</label>
                        <InputText id="email" style="background-color: #A7A7A7" name="email" type="email" autocomplete="email" placeholder="Username" required @bind-Value="Username" readonly/>
                        <p class="field-help sr-only" id="email-help">Enter your username.</p>
                    </div>

                    <div class="field">
                        <div class="field-row">
                            <label for="password">Password</label>
                            <NavLink class="link-small" href="/fpwIdentify">Forgot password?</NavLink>
                        </div>
                        <InputText id="password" style="background-color: #A7A7A7" name="password" type="password" autocomplete="current-password" placeholder="••••••••" required @bind-Value="Password" readonly/>
                        <p>You have @Attempts attempts remaining</p>
                    </div>

                    <!-- Role -->
                    <label class="field">
                        <span class="field__label">Role</span>
                        <InputSelect @bind-Value="Role" id="role" name="role" disabled>
                            <option value="Admin">Administrator</option>
                            <option value="Manager">Manager</option>
                            <option value="Accountant" selected>Accountant</option>
                        </InputSelect>
                    </label>
                    
                    <button type="button" class="btn btn-primary">Sign in</button>

                    <p class="footer-line">
                        <span class="muted">Need an account?</span>
                        <NavLink href="/cUser" class="link">Create one</NavLink>
                    </p>
                    <AntiforgeryToken/>
                </form>
            }
        </div>
    </section>
</main>
</body>

@code {
    public string Username { get; set; } = string.Empty;
    public string Password { get; set; } = string.Empty;
    public int Attempts = 3;
    public bool FormEnabled { get; set; } = true;
    public string Role { get; set; } = string.Empty;
    
    // Errors / Alerts
    public string MissingRole = string.Empty;
    public string AccountMismatch = string.Empty;
    public string IncorrectPassword = string.Empty;
    public string IncorrectUsername = string.Empty;
    public string AccountDisabled = string.Empty;
    public string SuspendedAccount = string.Empty;

    User currentUser = new User();

    public async Task VerifyLoginAsync()
    {
        try
        {
            // Reset Alerts
            AccountMismatch = string.Empty;
            IncorrectPassword = string.Empty;
            IncorrectUsername = string.Empty;
            MissingRole = string.Empty;
            SuspendedAccount = string.Empty;

            if (Role != string.Empty)
            {
                currentUser = await User.VerifyLogin(Username, Password);
                User cur = await User.VerifyLogin(Username, Password);
                Console.WriteLine(currentUser.GetType().Name);
                if (currentUser != null)
                {
                    // Role verification
                    if (currentUser is Admin)
                    {
                        if (Role == "Administrator")
                        {
                            NavigationManager.NavigateTo($"/dashboardN/{Username}");
                        }
                        else
                        {
                            AccountMismatch = "Login credentials do not match specified role";
                        }
                    }
                    else if (currentUser is Manager)
                    {
                        if (Role == "Manager")
                        {
                            NavigationManager.NavigateTo($"/dashboardN/{Username}");
                        }
                        else
                        {
                            AccountMismatch = "Login credentials do not match specified role";
                        }
                    }
                    else
                    {
                        if (Role == "Accountant")
                        {
                            NavigationManager.NavigateTo($"/dashboardN/{Username}");
                        }
                        else
                        {
                            AccountMismatch = "Login credentials do not match specified role";
                        }
                    }
                }
            }
            else
            {
                MissingRole = "Please select an account role";
            }
        }
        catch (InvalidUsernameException e)
        {
            SuspendedAccount = string.Empty;
            AccountMismatch = string.Empty;
            MissingRole = string.Empty;
            IncorrectUsername = "No user found with this username";
            Console.WriteLine("Process Failed: " + e.Message);
        }
        catch (InvalidPasswordException e)
        {
            SuspendedAccount = string.Empty;
            AccountMismatch = string.Empty;
            MissingRole = string.Empty;
            IncorrectPassword = "Password is invalid";
            Attempts--;
            if (Attempts <= 0)
            {
                DisableForm(currentUser);
            }
        }
        catch (InactiveUserException e)
        {
            AccountMismatch = string.Empty;
            MissingRole = string.Empty;
            SuspendedAccount = e.Message;
        }
        catch (Exception e)
        {
            Console.WriteLine("Error: " + e.Message);
        }

    }
    public void DisableForm(User cur)
    {
        // Clear form
        FormEnabled = false;
        
        // Disable prior alerts
        AccountMismatch = string.Empty;
        IncorrectPassword = string.Empty;
        IncorrectUsername = string.Empty;
        MissingRole = string.Empty;

        Console.WriteLine(cur.GetUserName());
        Console.WriteLine(cur.GetUserID());
        SuspendUser(cur);
    }

    public void SuspendUser(User cur)
    {
        // Suspend the account of the user trying to log in
        string startDate = DateTime.Today.ToString("yyyy-MM-dd");
        string endDate = DateTime.Today.AddDays(3).ToString("yyyy-MM-dd");

        Admin.DeactivateUser(Username, startDate, endDate);
        AccountDisabled = "Too many failed attempts - Account has been suspended";
    }

}